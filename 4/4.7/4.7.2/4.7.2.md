> [4. Decisiones Iniciales de Arquitectura](../../4.md) › [4.7. Listado Consolidado](../4.7.md) › [4.7.2. Modelo de Coordinación](4.7.2.md)

# 4.7.2. Modelo de Coordinación

Este apartado define los mecanismos a través de los cuales los microservicios de GameVault interactúan entre sí, garantizando la consistencia y el desacoplamiento.

## 00: Decisiones Generales
---
### Decisión 1: Patrón de Comunicación Inter-Servicios Principal

**Título:**
Elección del Patrón de Comunicación Principal: Síncrono vs. Asíncrono

**Contexto:**
GameVault requiere baja latencia para la interacción con el usuario (ej. búsqueda de productos, perfil de usuario) y una coordinación altamente confiable y auditable para los flujos transaccionales (ej. creación de pedidos, registro de pagos).

**Alternativas:**

* **Síncrono Exclusivo (REST/gRPC):** Fácil de implementar, pero genera alto acoplamiento y riesgos de fallos en cascada entre servicios.
* **Asíncrono Exclusivo (Event-Driven):** Máximo desacoplamiento, pero dificulta la retroalimentación inmediata al usuario sobre acciones completadas.
* **Híbrido (REST + Event-Driven):** Utiliza lo mejor de ambos: Síncrono para lecturas y Asíncrono para procesos de fondo o interacciones complejas.

**Criterios de Elección:**

* **Desacoplamiento:** Reducir la dependencia entre módulos transaccionales.
* **Latencia de Lectura:** Asegurar una respuesta rápida para el frontend.
* **Trazabilidad:** Capacidad de monitorear y auditar flujos de larga duración.

**Decisión:**
Se adopta un Modelo de Comunicación **Híbrido**: RESTful API para interacciones síncronas de lectura/escritura simples y Mensajería Asíncrona (Eventos/Colas) para la coordinación de procesos transaccionales y la replicación de datos.

**Sustento:**
El modelo Híbrido optimiza la **Latencia de Lectura** mediante llamadas REST directas. La comunicación **Asíncrona** aísla los módulos transaccionales de fallos en servicios secundarios, mejorando el **Desacoplamiento** y la resiliencia general del sistema.

### Decisión 2: Coordinación de Acceso del Frontend
---
**Título:**
Estrategia de Orquestación para el Acceso Externo (Frontend)

**Contexto:**
El frontend (Web/Móvil) debe consumir datos de múltiples módulos (ej. una página de producto necesita datos del CP, GU y CR) y autenticarse una sola vez. Se necesita un único punto de entrada para manejar la lógica de enrutamiento y agregación.

**Alternativas:**

* **Llamadas Directas del Cliente:** El frontend conoce y llama a cada microservicio individualmente. Introduce complejidad en el cliente y acoplamiento con la topología de la red interna.
* **API Gateway Centralizado:** Un punto de entrada que maneja seguridad, limitación de tasa y enrutamiento a los microservicios.
* **Backend for Frontend (BFF):** Una variación del Gateway, donde el Gateway tiene lógica de negocio específica para componer las vistas del cliente.

**Criterios de Elección:**

* **Seguridad:** Centralizar la autenticación y autorización.
* **Composición:** Capacidad de agregar datos de múltiples módulos en una sola respuesta.
* **Simplicidad para el Cliente:** Exponer una interfaz limpia y única al frontend.

**Decisión:**
Implementación de un **API Gateway Centralizado** que actúe como punto de entrada único, gestionando la seguridad y el enrutamiento. Se utiliza REST (JSON/HTTP) como protocolo estándar.

**Sustento:**
El API Gateway centraliza la **Seguridad** y simplifica el cliente. Utilizar REST para la comunicación externa es el estándar de la industria, garantizando **Simplicidad para el Cliente** y facilidad de integración con cualquier plataforma (Web, iOS, Android).

## 01: Módulo: Catálogo de Productos
--
### Decisión 1: Mecanismo de Consulta de Productos

**Título:**
Protocolo para Consultas de Productos (Lectura) desde el Frontend

**Contexto:**
El Catálogo es el módulo con la mayor demanda de lectura (búsqueda y filtros). La consulta debe ser de baja latencia.

**Alternativas:**

* **API REST Síncrona:** Consulta directa a la API, simple y rápida.
* **Eventos Asíncronos:** No es adecuado para consultas directas de lectura.

**Criterios de Elección:**

* **Latencia:** Minimizar el tiempo de respuesta.
* **Simplicidad:** Facilidad de implementación y consumo.

**Decisión:**
Comunicación **Síncrona** a través del API Gateway (RESTful API) para todas las consultas de productos.

**Sustento:**
La consulta directa (**síncrona**) es el mecanismo más eficiente para el acceso a datos de solo lectura, cumpliendo con la exigencia de **Baja Latencia** del Catálogo.

## 02: Módulo: Gestión de Usuarios
---
### Decisión 1: Consulta Síncrona de Perfiles de Usuario

**Título:**
Mecanismo para Consultar Roles y Perfiles de Usuario

**Contexto:**
Módulos como CCP, SP y CR necesitan consultar la información básica del usuario (ID, nombre, rol de comprador/vendedor) en tiempo real para autorizar o contextualizar una transacción/reseña.

**Alternativas:**

* **Llamada Síncrona a la API de GU (REST):** Consulta directa y de baja latencia al microservicio GU.
* **Replicación de Datos (Anti-Pattern):** Otros módulos replican los datos del perfil de usuario en sus propias bases de datos.

**Criterios de Elección:**

* **Oportunidad:** Necesidad de información de usuario en tiempo real (ej. rol de vendedor/comprador).
* **Consistencia:** El perfil del usuario debe ser siempre la única fuente de verdad.

**Decisión:**
Comunicación **Síncrona** a través de RESTful API para consultas de perfil.

**Sustento:**
La llamada **Síncrona** a GU garantiza la **Consistencia** y la **Oportunidad** de la información del perfil y rol, ya que los datos se consultan de la fuente de verdad en el momento de la necesidad.

## **03: Módulo: Carrito de Compras y Pedidos**
---
### **Decisión 1: Flujo de Creación de Pedido y Pago**

**Título:**
Mecanismo de Coordinación Síncrono para la Transacción de Venta

**Contexto:**
Según las restricciones del proyecto, la comunicación entre el CCP y el SP **debe ser síncrona**. El flujo requiere que el CCP cree un pedido preliminar, solicite el pago al SP de forma bloqueante, y solo finalice la creación del pedido (confirmando el inventario) si el pago es exitoso.

**Alternativas:**

* **Patrón SAGA (Asíncrono):** El Módulo CCP coordina los pasos con mensajes asíncronos. **(Descartado por la restricción del proyecto).**
* **Llamada Síncrona Directa (Request/Response):** El CCP invoca directamente al SP y espera una respuesta (éxito/fallo) antes de continuar con su propio flujo.

**Criterios de Elección:**

* **Cumplimiento de Restricciones:** Es el criterio principal. La arquitectura debe adherirse a las reglas definidas para el proyecto, como la comunicación síncrona obligatoria en este punto.
* **Simplicidad Transaccional:** Para un flujo lineal y directo (Pedido → Pago), un modelo síncrono es más simple de implementar, depurar y entender que un SAGA complejo.
* **Atomicidad del Proceso de Venta:** Asegura que la venta solo se considere completa si tanto la creación del pedido como el pago son exitosos, evitando inconsistencias.

**Decisión:**
Llamada Síncrona Directa (Request/Response).

**Sustento:**
Aunque una llamada síncrona crea un acoplamiento temporal más fuerte, es la única alternativa que satisface la **restricción explícita del proyecto** de confirmar el pago antes de finalizar el pedido. Este enfoque garantiza la **atomicidad** del núcleo de la transacción de venta de la manera más simple posible.

***

## **04: Módulo: Sistema de Pagos**
---
### **Decisión 1: Comunicación con Pasarelas Externas**

**Título:**
Protocolo de Interacción con Servicios de Pago Externos

**Contexto:**
El Módulo SP debe comunicarse con sistemas de terceros **(PayPal, Yape, Plin)**, los cuales tienen alta seguridad y latencia variable. La confirmación del pago debe ser confiable y no depender de que el usuario permane-zca en la página.

**Alternativas:**

* **Polling Síncrono:** El SP consulta repetidamente a la pasarela hasta que el pago se confirma. (Ineficiente y propenso a errores).
* **Webhooks Asíncronos (Callback):** El SP inicia el pago y espera una notificación (WebHook) de la pasarela para la confirmación final.

**Criterios de Elección:**

* **Fiabilidad:** Es la capacidad de garantizar que la notificación de pago no se pierda, incluso si la conexión del usuario falla. Se relaciona con la **Confiabilidad** del sistema.
* **Cumplimiento del Estándar del Proveedor:** Utilizar el mecanismo recomendado y estándar de la industria para cada pasarela asegura compatibilidad y soporte a largo plazo.
* **Eficiencia de Recursos:** Evita el consumo innecesario de recursos de red y cómputo que generaría el estar consultando (polling) constantemente por una respuesta.

**Decisión:**
Webhooks Asíncronos (Callback).

**Sustento:**
Los **Webhooks** son el mecanismo estándar de la industria para la confirmación de pagos. Esto garantiza la **Fiabilidad** de la notificación (incluso si la conexión del usuario se pierde) y mantiene al SP desacoplado del pro-ceso de espera, optimizando los recursos del sistema.

## 05: Módulo: Comunidad y Reseñas
---
### Decisión 1: Propagación de Eventos de Reseñas y Comentarios

**Título:**
Mecanismo para Sincronizar el Promedio de Valoración de Reseñas en el Catálogo

**Contexto:**
Cuando se aprueba una reseña en el Módulo CR, el Módulo CP necesita actualizar su metadato de "Puntuación Promedio" para mostrarlo en las páginas de producto y listados.

**Alternativas:**

* **Llamada Síncrona (CR a CP):** Bloquea el flujo de CR y si CP falla, el proceso de reseña se detiene.
* **Modelo Push (CR Publica Evento):** CR emite un evento y CP consume este evento para realizar la actualización de forma asíncrona.

**Criterios de Elección:**

* **Desacoplamiento:** El cálculo y la persistencia de la reseña (CR) deben ser independientes de la actualización del metadato (CP).
* **Resiliencia:** Si CP está caído, CR debe poder seguir aceptando reseñas.
z
**Decisión:**
Comunicación **Asíncrona (Eventos)**. CR publica eventos de dominio al que CP se suscribe.

**Sustento:**
El modelo **Asíncrono** garantiza el **Desacoplamiento** y la **Resiliencia**. El Módulo CR completa su trabajo y el Módulo CP realiza una actualización pasiva de los metadatos.

## 06: Módulo: Análisis de Datos y Reportes
---
### Decisión 1: Integración de Datos para Reportes

**Título:**
Integración de Datos para el Módulo de Análisis y Reportes

**Contexto:**
El Módulo ADR necesita consumir datos de todos los microservicios (CP, CCP, GU, CR, SP, LE) para construir su Data Warehouse y Data Lake. La ingesta de datos debe ser pasiva, continua y de alto rendimiento.

**Alternativas:**

* **Consultas a Bases de Datos (Anti-Pattern):** Acceso directo de ADR a las bases de datos de producción.
* **Event Streaming (Kafka):** Todos los microservicios publican eventos de negocio que ADR consume y procesa asíncronamente.

**Criterios de Elección:**

* **Aislamiento:** ADR debe estar totalmente desacoplado de los sistemas operativos (OLTP).
* **Tiempos de Proceso:** Los reportes pueden tolerar un ligero retardo (*near real-time*) para priorizar el rendimiento del *core*.

**Decisión:**
Uso de **Event Streaming (Asíncrono)**. Todos los microservicios publican eventos clave de negocio que ADR consume.

**Sustento:**
El **Event Streaming** garantiza el **Aislamiento** del Módulo ADR de los demás microservicios. Permite la ingesta de datos de manera eficiente y asíncrona, sin impactar el rendimiento de los módulos críticos transaccionales.

---

[⬅️ Anterior](../4.7.1/4.7.1.md) | [🏠 Home](../../../README.md) | [Siguiente ➡️](../4.7.3/4.7.3.md)