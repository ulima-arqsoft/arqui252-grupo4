<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Compras</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2> Compras</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-view="products">
                     Productos
                </a>
                <a href="#" class="nav-item" data-view="purchases">
                     Mis Compras
                </a>
                <a href="#" class="nav-item" data-view="security">
                     Seguridad
                </a>
            </nav>
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-danger btn-block">
                    Cerrar Sesión
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="dashboard-header">
                <h1 id="viewTitle">Productos Disponibles</h1>
                <div class="user-info">
                    <span id="userName">Usuario</span>
                    <span class="badge" id="userRole">user</span>
                </div>
            </header>

            <!-- Alert -->
            <div id="dashboardAlert" class="alert" style="display: none;"></div>

            <!-- Products View -->
            <section id="productsView" class="view-section">
                <div class="products-grid" id="productsGrid">
                    <div class="loading">Cargando productos...</div>
                </div>
            </section>

            <!-- Purchases View -->
            <section id="purchasesView" class="view-section" style="display: none;">
                <div class="purchases-list" id="purchasesList">
                    <div class="loading">Cargando compras...</div>
                </div>
            </section>

            <!-- Security View -->
            <section id="securityView" class="view-section" style="display: none;">
                <div class="security-metrics">
                    <h2>Métricas de Seguridad del Contenedor</h2>
                    <div id="securityMetrics" class="metrics-grid">
                        <div class="loading">Cargando métricas...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Realizar Compra</h2>
            <div id="modalProductInfo"></div>
            <form id="purchaseForm">
                <input type="hidden" id="modalProductId">
                <div class="form-group">
                    <label for="quantity">Cantidad:</label>
                    <input type="number" id="quantity" min="1" max="100" value="1" required>
                </div>
                <div class="form-group">
                    <label>Total:</label>
                    <div class="total-price" id="totalPrice">$0.00</div>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    Confirmar Compra
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentUser = null;
        let currentToken = null;
        let currentProduct = null;

        // Check authentication
        function checkAuth() {
            currentToken = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if (!currentToken || !userStr) {
                window.location.href = 'login.html';
                return false;
            }
            
            currentUser = JSON.parse(userStr);
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role;
            return true;
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('dashboardAlert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // API call with auth
        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentToken}`,
                ...options.headers
            };
            
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers
            });
            
            if (response.status === 401 || response.status === 403) {
                localStorage.clear();
                window.location.href = 'login.html';
                throw new Error('No autorizado');
            }
            
            return response;
        }

        // Load products
        async function loadProducts() {
            try {
                const response = await apiCall('/api/products');
                const products = await response.json();
                
                const grid = document.getElementById('productsGrid');
                
                if (products.length === 0) {
                    grid.innerHTML = '<p class="no-data">No hay productos disponibles</p>';
                    return;
                }
                
                grid.innerHTML = products.map(product => `
                    <div class="product-card">
                        <div class="product-header">
                            <h3>${product.name}</h3>
                            <span class="badge badge-${product.category.toLowerCase()}">${product.category}</span>
                        </div>
                        <p class="product-description">${product.description}</p>
                        <div class="product-info">
                            <div class="product-price">$${product.price.toFixed(2)}</div>
                            <div class="product-stock">
                                Stock: ${product.stock} unidades
                            </div>
                        </div>
                        <button 
                            class="btn btn-primary btn-block" 
                            onclick="openPurchaseModal(${product.id}, '${product.name}', ${product.price}, ${product.stock})"
                            ${product.stock === 0 ? 'disabled' : ''}
                        >
                            ${product.stock > 0 ? 'Comprar' : 'Sin Stock'}
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                showAlert('Error al cargar productos', 'error');
            }
        }

        // Load purchases
        async function loadPurchases() {
            try {
                const response = await apiCall('/api/purchases');
                const purchases = await response.json();
                
                const list = document.getElementById('purchasesList');
                
                if (purchases.length === 0) {
                    list.innerHTML = '<p class="no-data">No tienes compras registradas</p>';
                    return;
                }
                
                list.innerHTML = purchases.map(purchase => `
                    <div class="purchase-item">
                        <div class="purchase-header">
                            <h3>${purchase.product_name}</h3>
                            <span class="badge badge-${purchase.status}">${purchase.status}</span>
                        </div>
                        <div class="purchase-details">
                            <p>Cantidad: ${purchase.quantity}</p>
                            <p>Precio unitario: $${purchase.price.toFixed(2)}</p>
                            <p class="purchase-total">Total: $${purchase.total.toFixed(2)}</p>
                        </div>
                        <div class="purchase-date">
                            ${new Date(purchase.created_at).toLocaleDateString('es-ES', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading purchases:', error);
                showAlert('Error al cargar compras', 'error');
            }
        }

        // Load security metrics
        async function loadSecurityMetrics() {
            try {
                const response = await apiCall('/api/security/metrics');
                const metrics = await response.json();
                
                const container = document.getElementById('securityMetrics');
                container.innerHTML = `
                    <div class="metric-card">
                        <h3> Información del Contenedor</h3>
                        <ul>
                            <li><strong>Usuario:</strong> ${metrics.containerInfo.user}</li>
                            <li><strong>Entorno:</strong> ${metrics.containerInfo.nodeEnv}</li>
                            <li><strong>Plataforma:</strong> ${metrics.containerInfo.platform}</li>
                            <li><strong>Node Version:</strong> ${metrics.containerInfo.nodeVersion}</li>
                        </ul>
                    </div>
                    
                    <div class="metric-card">
                        <h3> Características de Seguridad</h3>
                        <ul>
                            ${Object.entries(metrics.securityFeatures).map(([key, value]) => `
                                <li>
                                    <strong>${key}:</strong> 
                                    <span class="badge ${value ? 'badge-success' : 'badge-danger'}">
                                        ${value ? '✓ Activo' : '✗ Inactivo'}
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="metric-card">
                        <h3> Uso de Recursos</h3>
                        <ul>
                            <li><strong>Memoria RSS:</strong> ${(metrics.resourceUsage.memory.rss / 1024 / 1024).toFixed(2)} MB</li>
                            <li><strong>Heap Usado:</strong> ${(metrics.resourceUsage.memory.heapUsed / 1024 / 1024).toFixed(2)} MB</li>
                            <li><strong>Heap Total:</strong> ${(metrics.resourceUsage.memory.heapTotal / 1024 / 1024).toFixed(2)} MB</li>
                            <li><strong>Uptime:</strong> ${(metrics.resourceUsage.uptime / 60).toFixed(2)} minutos</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading security metrics:', error);
                showAlert('Error al cargar métricas de seguridad', 'error');
            }
        }

        // Open purchase modal
        function openPurchaseModal(id, name, price, stock) {
            currentProduct = { id, name, price, stock };
            document.getElementById('modalProductId').value = id;
            document.getElementById('modalProductInfo').innerHTML = `
                <p><strong>${name}</strong></p>
                <p>Precio: $${price.toFixed(2)}</p>
                <p>Stock disponible: ${stock} unidades</p>
            `;
            document.getElementById('quantity').max = stock;
            updateTotal();
            document.getElementById('purchaseModal').style.display = 'flex';
        }

        // Update total price
        function updateTotal() {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const total = currentProduct.price * quantity;
            document.getElementById('totalPrice').textContent = `$${total.toFixed(2)}`;
        }

        // Close modal
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('purchaseModal').style.display = 'none';
        });

        // Purchase form
        document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const quantity = parseInt(document.getElementById('quantity').value);
            
            try {
                const response = await apiCall('/api/purchases', {
                    method: 'POST',
                    body: JSON.stringify({
                        productId: currentProduct.id,
                        quantity: quantity
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Compra realizada exitosamente!', 'success');
                    document.getElementById('purchaseModal').style.display = 'none';
                    loadProducts();
                } else {
                    showAlert(data.error || 'Error al realizar compra', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al procesar compra', 'error');
            }
        });

        // Quantity change
        document.getElementById('quantity').addEventListener('input', updateTotal);

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const view = item.dataset.view;
                
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                document.querySelectorAll('.view-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                document.getElementById(`${view}View`).style.display = 'block';
                
                const titles = {
                    products: 'Productos Disponibles',
                    purchases: 'Mis Compras',
                    security: 'Métricas de Seguridad'
                };
                document.getElementById('viewTitle').textContent = titles[view];
                
                if (view === 'products') loadProducts();
                if (view === 'purchases') loadPurchases();
                if (view === 'security') loadSecurityMetrics();
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = 'login.html';
        });

        // Initialize
        if (checkAuth()) {
            loadProducts();
        }
    </script>
</body>
</html>