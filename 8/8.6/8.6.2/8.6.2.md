> [8. Aplicaci√≥n de Patrones Arquitecturales](../../8.md) ‚Ä∫ [8.6. Listado Consolidado](../8.6.md) ‚Ä∫ [8.6.2. Patrones de Componente y Conector](8.6.2.md)

# 8.6.2. Patrones de Componente y Conector

## **03: M√≥dulo: Carrito de Compras y Pedidos**

---

**T√≠tulo:**
Patr√≥n de Persistencia H√≠brida para Carritos y Pedidos

**Contexto:**
El M√≥dulo 3: Carrito de Compras y Pedidos (CCP) maneja dos tipos de datos con necesidades opuestas. El **carrito de compras** es temporal, vol√°til y requiere acceso de muy alta velocidad para no afectar la experiencia del usuario. Por otro lado, los **pedidos** son permanentes, transaccionales y la "fuente de verdad" de una venta completada. Se necesita una estrategia de persistencia que optimice el rendimiento para los carritos sin sacrificar la consistencia transaccional de los pedidos.

**Alternativas:**

* **Patr√≥n de Datos Compartidos (H√≠brido: Redis + SQL):**
    * Usa `Redis` para los carritos (en memoria) y `PostgreSQL` para los pedidos (en disco).
    * Ventaja: Alto rendimiento del carrito y fuerte consistencia (ACID) para pedidos.
    * Ventaja: Las operaciones del carrito no sobrecargan la BD transaccional.
    * Desventaja: Requiere mantener y conectar dos sistemas de BD.

* **Patr√≥n de Datos Compartidos (Relacional √önico):**
    * Usa `PostgreSQL` para almacenar *tanto* carritos como pedidos.
    * Ventaja: Simplicidad (una sola tecnolog√≠a de BD).
    * Desventaja: Bajo rendimiento del carrito (cada "a√±adir" es una escritura en disco).
    * Desventaja: La BD de pedidos se "ensucia" con datos temporales de carritos abandonados.

**Criterios de elecci√≥n:**

* **Rendimiento del Carrito:** La UI debe ser instant√°nea al a√±adir/quitar √≠tems (`RF-01`).
* **Consistencia Transaccional:** Los pedidos completados (ventas) deben ser 100% fiables (ACID).
* **Desacoplamiento de Carga:** Las operaciones del carrito (alta frecuencia) no deben afectar el rendimiento de la BD de pedidos (alta criticidad).

**Decisi√≥n:**
Se adopta el **Patr√≥n de Datos Compartidos H√≠brido (Redis + SQL)**.

**Sustento:**
Esta decisi√≥n es obligatoria por las restricciones del proyecto, que indican expl√≠citamente el uso de `Redis` para el carrito y `PostgreSQL` para los pedidos. Es la √∫nica alternativa que cumple con los requisitos de alto rendimiento (`RF-01`) sin sacrificar la consistencia.

El `Servicio de Carrito y Pedidos (CCP)` implementa esta separaci√≥n, donde el `CartRepository` escribe en `Redis` y el `OrderRepository` escribe en `PostgreSQL`

## **04: M√≥dulo: Sistema de Pagos**

--

**T√≠tulo:**
Uso de Webhooks As√≠ncronos (Patr√≥n Publicar-Suscribir) para Confirmaci√≥n de Pagos

**Contexto:**
El M√≥dulo 4 (SP) debe recibir la confirmaci√≥n de pago del proveedor externo Culqi. El sistema debe ser 100% fiable, ya que esta confirmaci√≥n es la que autoriza la creaci√≥n de un pedido en el M√≥dulo 3. Se debe definir el mecanismo de comunicaci√≥n (conector) para recibir esta confirmaci√≥n.

**Alternativas:**

* **Webhooks As√≠ncronos (Patr√≥n Publicar-Suscribir):**
    * Culqi (Publicador) env√≠a un evento (HTTP POST) a un endpoint nuestro (Suscriptor) cuando el pago se completa.
    * Ventaja: Alta fiabilidad; garantiza la entrega incluso si el usuario cierra el navegador.
    * Ventaja: Desacoplado; el sistema reacciona a eventos en lugar de gastar recursos esperando.
    * Desventaja: Requiere un endpoint p√∫blico seguro para recibir el evento.

* **Polling S√≠ncrono (Patr√≥n Solicitud-Respuesta):**
    * Nuestro Servicio de Pagos (SP) pregunta a la API de Culqi repetidamente ("polling") si el pago ya se realiz√≥.
    * Ventaja: Flujo de c√≥digo aparentemente m√°s simple.
    * Desventaja: Muy fr√°gil; falla si el usuario cierra la ventana, dejando el pedido en el limbo.
    * Desventaja: Ineficiente (genera tr√°fico de red innecesario) y prohibido por la mayor√≠a de las pasarelas.

**Criterios de elecci√≥n:**

* **Fiabilidad:** Garantizar la captura del 100% de los pagos (RF-03).
* **Desacoplamiento:** No bloquear el Servicio de Pagos (SP) esperando una respuesta s√≠ncrona.
* **Cumplimiento de Proveedor:** Seguir las mejores pr√°cticas y requisitos obligatorios del proveedor (Culqi).

**Decisi√≥n:**
Se adopta el patr√≥n de Webhooks As√≠ncronos (Publicar-Suscribir).

**Sustento:**
La decisi√≥n es obligatoria seg√∫n la restricci√≥n del proyecto: "Las notificaciones de transacciones [...] deben ser gestionadas a trav√©s de los webhooks proporcionados por cada pasarela de pago". Este patr√≥n es el √∫nico que cumple el requisito de fiabilidad RF-03.

---

[‚¨ÖÔ∏è Anterior](../8.6.1/8.6.1.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../8.6.3/8.6.3.md)